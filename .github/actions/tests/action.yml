name: Tests
description: Run Unit tests (Vitest) and E2E tests (Playwright)

inputs:
  github_token:
    description: 'GitHub token'
    required: false
    default: ${{ github.token }}
  has_app:
    description: 'Whether this repo has an app (enables E2E)'
    required: false
    default: 'false'
  run_e2e:
    description: 'Whether to run E2E tests'
    required: false
    default: 'true'

outputs:
  unit_passed:
    description: 'Whether unit tests passed'
    value: ${{ steps.unit.outputs.passed }}
  e2e_passed:
    description: 'Whether E2E tests passed'
    value: ${{ steps.e2e.outputs.passed }}
  screenshot_count:
    description: 'Number of screenshots captured'
    value: ${{ steps.screenshots.outputs.count }}

runs:
  using: composite
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install dependencies
      shell: bash
      run: npm ci

    - name: Unit Tests (Vitest)
      id: unit
      shell: bash
      run: |
        echo "Running unit tests..."

        # Check if vitest config or test files exist
        if [ -f "vitest.config.ts" ] || [ -f "vitest.config.js" ] || find . -name "*.test.ts" -o -name "*.test.tsx" 2>/dev/null | head -1 | grep -q .; then
          if npm run test 2>&1 || npx vitest run 2>&1; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "✓ Unit tests passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "✗ Unit tests failed"
            exit 1
          fi
        else
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "⊘ No unit tests found, skipping"
        fi

    - name: Install Playwright
      if: inputs.has_app == 'true' && inputs.run_e2e == 'true'
      shell: bash
      run: npx playwright install chromium --with-deps

    - name: E2E Tests (Playwright)
      id: e2e
      if: inputs.has_app == 'true' && inputs.run_e2e == 'true'
      shell: bash
      run: |
        echo "Running E2E tests..."

        # Check if playwright config exists
        if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
          mkdir -p .playwright-screenshots

          if npx playwright test --project=chromium --screenshot=on --output=.playwright-screenshots 2>&1; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "✓ E2E tests passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "✗ E2E tests failed"
            exit 1
          fi
        else
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "⊘ No Playwright config found, skipping"
        fi

    - name: Skip E2E (no app)
      if: inputs.has_app != 'true' || inputs.run_e2e != 'true'
      id: e2e-skip
      shell: bash
      run: |
        echo "passed=true" >> $GITHUB_OUTPUT
        echo "⊘ E2E skipped (no app or disabled)"

    - name: Collect screenshots
      id: screenshots
      if: inputs.has_app == 'true' && inputs.run_e2e == 'true'
      shell: bash
      run: |
        mkdir -p .claude/screenshots

        # Collect from playwright output
        find .playwright-screenshots -name "*.png" -type f 2>/dev/null | while read -r file; do
          UNIQUE_NAME=$(basename "$file")
          cp "$file" ".claude/screenshots/${UNIQUE_NAME}" 2>/dev/null || true
        done

        # Collect from test-results
        find test-results -name "*.png" -type f 2>/dev/null | while read -r file; do
          UNIQUE_NAME=$(basename "$file")
          cp "$file" ".claude/screenshots/${UNIQUE_NAME}" 2>/dev/null || true
        done

        COUNT=$(ls -1 .claude/screenshots/*.png 2>/dev/null | wc -l || echo "0")
        echo "count=$COUNT" >> $GITHUB_OUTPUT
        echo "Collected $COUNT screenshots"

    - name: Upload screenshots
      if: inputs.has_app == 'true' && steps.screenshots.outputs.count > 0
      uses: actions/upload-artifact@v4
      with:
        name: playwright-screenshots-${{ github.sha }}
        path: .claude/screenshots/
        retention-days: 7
