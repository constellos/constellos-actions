name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

permissions:
  contents: read
  pull-requests: write
  issues: read

concurrency:
  group: ci-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Job 1: Static Analysis (Lint + Types)
  # ============================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/static-analysis
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Job 2: Tests (Unit + E2E)
  # Requires: Static Analysis passes
  # ============================================
  tests:
    name: Tests
    needs: static-analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/tests
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          has_app: 'false'  # Set to 'true' for repos with apps

  # ============================================
  # Job 3: Reviews (Requirements, Code Quality, Context, UI)
  # Requires: Tests pass
  # Only runs on pull_request
  # ============================================
  reviews:
    name: Reviews
    needs: tests
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/reviews
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          has_app: 'false'  # Set to 'true' for repos with apps
